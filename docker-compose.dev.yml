services:
  # PostgreSQL (dev)
  postgres_dev:
    container_name: postgres_dev
    build:
      context: ./
      dockerfile: ./postgres/Dockerfile
    restart: unless-stopped
    volumes:
      - postgres_dev:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ${DIR_LOG}/postgresql:/var/log/postgresql
    ports:
      - "${PG_PORT_DEV:-55432}:5432" # different host port for dev
    environment:
      - POSTGRES_USER=${PG_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${PG_DB_NAME}
      - PGDATA=/var/lib/postgresql/data/pgdata
      - TZ=Asia/Tashkent
      - POSTGRES_INITDB_ARGS=--auth-host=md5
    command: >
      postgres
      -c max_connections=${PG_MAX_CONNECTIONS:-100}
      -c password_encryption=md5
      -c shared_preload_libraries=pg_stat_statements,pg_cron,pgaudit,http,pgcrypto,uuid-ossp
      -c log_timezone='Asia/Tashkent'
      -c logging_collector=off
      -c log_directory='/var/log/postgresql'
      -c log_filename='postgresql-%Y-%m-%d.log'
      -c log_statement=none
      -c log_min_messages=log
      -c log_min_error_statement=log
      -c log_line_prefix='%m [%p] %q%u@%d '
      -c log_rotation_age=1d
      -c log_rotation_size=10MB
    networks:
      - dev
    stdin_open: true
    tty: true

  # PgBouncer transaction pool (dev)
  pgbouncer_tx_dev:
    container_name: pgbouncer_tx_dev
    build:
      context: ./pgbouncer
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - postgres_dev
    ports:
      - "${PGB_TX_PORT_DEV}:5432"
    environment:
      DB_USER: ${PG_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_HOST: postgres_dev
      DB_PORT: 5432
      AUTH_TYPE: md5
      ADMIN_USERS: ${PG_USER}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: ${PGB_MAX_CLIENT_CONN:-200}
      DEFAULT_POOL_SIZE: ${PGB_DEFAULT_POOL_SIZE:-20}
      LISTEN_ADDR: 0.0.0.0
      LISTEN_PORT: 5432
    networks:
      - dev
    stdin_open: true
    tty: true

  # PgBouncer session pool (dev)
  pgbouncer_sess_dev:
    container_name: pgbouncer_sess_dev
    build:
      context: ./pgbouncer
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - postgres_dev
    ports:
      - "${PGB_SESS_PORT_DEV}:5432"
    environment:
      DB_USER: ${PG_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_HOST: postgres_dev
      DB_PORT: 5432
      AUTH_TYPE: md5
      ADMIN_USERS: ${PG_USER}
      POOL_MODE: session
      MAX_CLIENT_CONN: ${PGB_MAX_CLIENT_CONN:-200}
      DEFAULT_POOL_SIZE: ${PGB_DEFAULT_POOL_SIZE:-20}
      LISTEN_ADDR: 0.0.0.0
      LISTEN_PORT: 5432
    networks:
      - dev
    stdin_open: true
    tty: true

  # PostgREST (dev)
  pgrest_dev:
    container_name: pgrest_dev
    build:
      context: ./pgrest
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - pgbouncer_sess_dev
    ports:
      - "${PGRST_PORT_DEV:-9000}:3000"
    environment:
      - ROOT_PASSWORD=${ROOT_PASSWORD}
      - PGRST_DB_URI=postgres://${PG_USER}:${DB_PASSWORD}@pgbouncer_sess_dev:5432/${PG_DB_NAME}
      - PGRST_DB_ANON_ROLE=web_anon
      - PGRST_JWT_SECRET=${PGRST_JWT_SECRET}
      - TZ=Asia/Tashkent
    networks:
      - dev
    stdin_open: true
    tty: true

volumes:
  postgres_dev:
    driver: local

networks:
  dev:
    driver: bridge
